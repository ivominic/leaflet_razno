<!doctype html>
<html>
  <head>
    <title>WMS GetFeatureInfo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css" />
    <link href="css/multiselect.css" rel="stylesheet"/>
    <script src="js/multiselect.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <script src="js/leaflet-sidebar.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/L.TileLayer.BetterWMS.js"></script>
    <link rel="stylesheet" href="css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style type="text/css">
      html, body, #map {
        margin: 0px;
        height: 100%;
        width: 100%;
        font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
      }
/* Change cursor when mousing over clickable layer */
/*.leaflet-clickable {
  cursor: crosshair !important;
}*/
/* Change cursor when over entire map */
/*.leaflet-container {
  cursor: help !important;
}*/
      body {
        padding: 0;
        margin: 0;
      }


    </style>
  </head>
  <body>
    <div id="map"></div>

        <!-- optionally define the sidebar content via HTML markup -->
        <div id="sidebar" class="leaflet-sidebar collapsed">

          <!-- nav tabs -->
          <div class="leaflet-sidebar-tabs">
              <!-- top aligned tabs -->
              <ul role="tablist">
                  <li><a href="#home" role="tab"><i class="fa fa-bars active"></i></a></li>                  
              </ul>
          </div>
  
          <!-- panel content -->
          <div class="leaflet-sidebar-content">
              <div class="leaflet-sidebar-pane" id="home">
                  <h1 class="leaflet-sidebar-header">
                      Pretraga
                      <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                  </h1>

                  <div>
                    <label for="opstina">Odaberite opštinu:</label></br>
                    <select class="form-control" id="opstina" multiple>
                        <option value="Andrijevica">Andrijevica</option>
                        <option value="Bar">Bar</option>
                        <option value="Budva">Budva</option>
                        <option value="Cetinje">Cetinje</option>
                        <option value="Podgorica">Podgorica</option>
                    </select>
                  </div>

                  <div>
                    <label for="naponskiNivo">Odaberite naponski nivo:</label></br>
                    <select class="form-control" id="naponskiNivo" multiple>
                        <option value="0.4 kV">0.4 kv</option>
                        <option value="10 kV">10 kv</option>
                        <option value="35 kV">35 kv</option>
                        <option value="Optika">Optika</option>
                        <option value="ADSS">ADSS</option>
                        <option value="OPGW">OPGW</option>
                    </select>
                  </div>                  

                  <div class="form-group">
                    <label for="atribut">Odaberite atribut pretrage:</label>
                    <select class="form-control" id="atribut">
                        <option value="name">Name</option>
                        <option value="description">Description</option>                        
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="vrijednost">Vrijednost za pretra&#382;ivanje:</label>
                    <input type="text" class="form-control" id="vrijednost">
                  </div>
                  <div class="form-group">
                      <button type="button" class="btn btn-primary" id="btnAtribut" onclick="dodajAtribut()">Dodaj uslov</button>
                    <button type="button" class="btn btn-success" id="btnPretraga" onclick="pretraga()">Pretraga</button>
                    <button type="button" class="btn btn-danger" id="btnRestart" onclick="restartovanje()">Restart</button>
                  </div>                    
  
              </div>
  
              <div class="leaflet-sidebar-pane" id="messages">
                  <h1 class="leaflet-sidebar-header">Messages<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
              </div>
          </div>
      </div>
  

    

    <script>
      var map = L.map('map', {
        center: [42,20],
        zoom: 7
      });

      var cql_text = "";
      
      document.multiselect('#opstina');
      document.multiselect('#naponskiNivo');

      //var url = 'http://localhost/geoserver/winsoft/wms';
      var url = 'http://localhost/geoserver/wms';
      
      var osmLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);
      
      var planinica = L.tileLayer.betterWms(url, {
        layers: 'winsoft:planinica',
        transparent: true,
        format: 'image/png'
      }).addTo(map);
      planinica.getContainer().setAttribute('id', 'wmsContainer');

      var jezero = L.tileLayer.betterWms(url, {
        layers: 'winsoft:jezero',
        transparent: true,
        format: 'image/png'
      }).addTo(map);

      var baseMaps = {
        "OSM": osmLayer
      };
      var wmsLayers = {
        "Planinica": planinica,
        "Jezero": jezero
      };

      var lejeriZaFiltriranje = wmsLayers;
    

      // create the sidebar instance and add it to the map
      var sidebar = L.control.sidebar({ container: 'sidebar' }).addTo(map);
      var lejeri = L.control.layers(baseMaps, wmsLayers).addTo(map);

      map.on('overlayadd', function(e){
        console.log('dodao lejer');
        console.log(e);        
      });
      map.on('overlayremove', function(e){
        console.log('uklonio lejer');
        console.log(e);
      });

      /*$('opstina').on('change', function() {
        console.log( this.value );
      });*/

      function dodajAtribut(){
        var atribut = $("#atribut option:selected").val();
        var vrijednost = $("#vrijednost").val();

        if(vrijednost.trim() === '' || typeof vrijednost === undefined){
          alert('Potrebno je unijeti vrijednost atributa');
        }else{
          if(cql_text === ""){
            cql_text = atribut + " LIKE '%" + vrijednost + "%'"
          }else{
            cql_text += " AND " + atribut + " LIKE '%" + vrijednost + "%'"
          }          
        }
      }

      function restartovanje(){
        lejeri._layers.forEach(function(obj) {
          if (obj.overlay) {
            //provjerava da li je aktivan na mapi ili ne, i prikazuje njegovo ime
            if(lejeri._map.hasLayer(obj.layer)){              
              obj.layer.setParams({cql_filter: 'INCLUDE'}); //'INCLUDE' vrijednost u cql_filteru vrši neku vrstu reseta
              cql_text = "";
              //console.log(obj.layer.wmsParams);
            }
          }
        });
      }
  

      function pretraga(){

        var temp_opstina = "";
        if($("#opstina option:selected").size() === $("#opstina option").size()){
          //Ako je sve selektovano ne radi se ništa
        }else{        
          $.each($("#opstina option:selected"), function(){
            temp_opstina += "'" + $(this).val() + "',"
          }).promise().done(function () { 
            if(temp_opstina !== ""){
            //Uklanja poslednji zarez
            temp_opstina = temp_opstina.substring(0, temp_opstina.length - 1);
            if(cql_text === ""){
              cql_text = "v_opstina IN (" + temp_opstina + ")"
            }else{
              cql_text += " AND v_opstina IN (" + temp_opstina + ")"
            }
          }

          }).promise().done(function () { 

          });    
        }

        //console.log(lejeri.getOverlays());
        if($("#naponskiNivo option:selected").size() === $("#naponskiNivo option").size()){
          //Ako je sve selektovano ne radi se ništa
        }else{
          var temp_nivo = "";
          $.each($("#naponskiNivo option:selected"), function(){            
            temp_nivo += "'" + $(this).val() + "',"
          });
          if(temp_nivo !== ""){
            //Uklanja poslednji zarez
            temp_nivo = temp_nivo.substring(0, temp_nivo.length - 1);
            if(cql_text === ""){
              cql_text = "v_napon IN (" + temp_nivo + ")"
            }else{
              cql_text += " AND v_napon IN (" + temp_nivo + ")"
            }
          }
        }


        lejeri._layers.forEach(function(obj) {
            if (obj.overlay) {
              //provjerava da li je aktivan na mapi ili ne, i prikazuje njegovo ime
              if(lejeri._map.hasLayer(obj.layer)){
                //console.log(obj);
                console.log(cql_text);
                if(cql_text !== ""){
                  obj.layer.setParams({cql_filter : cql_text});
                  //obj.layer.setParams({cql_filter : "name LIKE '%MB%'"});
                  //console.log('Filtriranje');
                  console.log(cql_text);
                }else{
                  //console.log('Prazan filter');
                }
              }else{
                //Za neaktivne ne raditi ništa
              }
            }
          });
          // jezero.setParams({cql_filter : "broj >= 10000"});
            //console.log(jezero.options);

      }

//console.log(map._layers.wmsParams);

    </script>  
  </body>
</html>