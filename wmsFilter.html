<!doctype html>
<html>
  <head>
    <title>WMS GetFeatureInfo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css" />
    <link href="css/multiselect.css" rel="stylesheet"/>
    <script src="js/multiselect.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <script src="js/leaflet-sidebar.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/L.TileLayer.BetterWMS.js"></script>
    <link rel="stylesheet" href="css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style type="text/css">
      html, body, #map {
        margin: 0px;
        height: 100%;
        width: 100%;
      }
/* Change cursor when mousing over clickable layer */
/*.leaflet-clickable {
  cursor: crosshair !important;
}*/
/* Change cursor when over entire map */
/*.leaflet-container {
  cursor: help !important;
}*/
body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            text-align: justify;
            color: #AAA;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

        <!-- optionally define the sidebar content via HTML markup -->
        <div id="sidebar" class="leaflet-sidebar collapsed">

          <!-- nav tabs -->
          <div class="leaflet-sidebar-tabs">
              <!-- top aligned tabs -->
              <ul role="tablist">
                  <li><a href="#home" role="tab"><i class="fa fa-bars active"></i></a></li>                  
              </ul>
          </div>
  
          <!-- panel content -->
          <div class="leaflet-sidebar-content">
              <div class="leaflet-sidebar-pane" id="home">
                  <h1 class="leaflet-sidebar-header">
                      Pretraga
                      <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                  </h1>

                  <div>
                    <label for="opstina">Odaberite opštinu:</label>
                    <select class="form-control" id="opstina" multiple>
                        <option value="Andrijevica">Andrijevica</option>
                        <option value="Bar">Bar</option>
                        <option value="Budva">Budva</option>
                        <option value="Cetinje">Cetinje</option>
                        <option value="Podgorica">Podgorica</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="atribut">Odaberite atribut pretrage:</label>
                    <select class="form-control" id="atribut">
                        <option value="name">Name</option>
                        <option value="description">Description</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="vrijednost">Vrijednost za pretra&#382;ivanje:</label>
                    <input type="text" class="form-control" id="vrijednost">
                  </div>
                  <div class="form-group">
                    <button type="button" class="btn btn-primary" id="btnPretraga" onclick="pretraga()">Pretraga</button>
                    <!--<button type="button" class="btn btn-danger" id="btnRestart" onclick="restartovanje()">Restart</button>-->
                  </div>                    
  
              </div>
  
              <div class="leaflet-sidebar-pane" id="messages">
                  <h1 class="leaflet-sidebar-header">Messages<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
              </div>
          </div>
      </div>
  

    

    <script>
      var map = L.map('map', {
        center: [42,20],
        zoom: 7
      });
      
      document.multiselect('#opstina');

      //var url = 'http://localhost/geoserver/winsoft/wms';
      var url = 'http://localhost/geoserver/wms';
      
      var osmLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);
      
      var svetiljke = L.tileLayer.betterWms(url, {
        layers: 'winsoft:svetiljke',
        transparent: true,
        format: 'image/png'
      }).addTo(map);
      svetiljke.getContainer().setAttribute('id', 'wmsContainer');

      var bare = L.tileLayer.betterWms(url, {
        layers: 'winsoft:bare',
        transparent: true,
        //cql_filter : "broj >= 10000",
        format: 'image/png'
      }).addTo(map);

      var baseMaps = {
        "OSM": osmLayer
      };
      var wmsLayers = {
        "Svetiljke": svetiljke,
        "Bare": bare
      };

      var lejeriZaFiltriranje = wmsLayers;


      L.Control.Layers.include({
  getOverlays: function() {
    // create hash to hold all layers
    var control, layers;
    layers = {};
    control = this;

    // loop thru all layers in control
    control._layers.forEach(function(obj) {
      var layerName;

      // check if layer is an overlay
      if (obj.overlay) {
        // get name of overlay
        layerName = obj.name;
        // store whether it's present on the map or not
        return layers[layerName] = control._map.hasLayer(obj.layer);
      }
    });

    return layers;
  }
});

      // create the sidebar instance and add it to the map
      var sidebar = L.control.sidebar({ container: 'sidebar' }).addTo(map);
      var lejeri = L.control.layers(baseMaps, wmsLayers).addTo(map);

      map.on('overlayadd', function(e){
        console.log('dodao lejer');
        console.log(e);        
      });
      map.on('overlayremove', function(e){
        console.log('uklonio lejer');
        console.log(e);
      });

function pretraga(){

  if($("#opstina option:selected").size() === $("#opstina option").size()){
    console.log('Sve je selektovano');
  }else{
    console.log('Selektovane pojedine opštine');
    //TODO: Kreirati upit za određene opštine
    $.each($("#opstina option:selected"), function(){            
      console.log($(this).val());
    });
  }
  //console.log(lejeri.getOverlays());

  lejeri._layers.forEach(function(obj) {
      if (obj.overlay) {
        //provjerava da li je aktivan na mapi ili ne, i prikazuje njegovo ime
        if(lejeri._map.hasLayer(obj.layer)){
          console.log(obj);
          obj.layer.setParams({cql_filter : "broj >= 10000 or broj < 2500"});
          console.log('aktivan')
        }else{
          console.log(obj.name);
          console.log('neaktivan');
        }
      }
    });

    var atributPretrage = $("#atribut option:selected").val();
    var vrijednostPretrage = $("#vrijednost").val();
      /*if(vrijednostPretrage.trim() === ''){
        alert('Potrebno je unijeti vrijednost za pretragu.');
        return false
      }*/

     // bare.setParams({cql_filter : "broj >= 10000"});


      //console.log(bare.options);

}

console.log(map._layers.wmsParams);

    </script>  
  </body>
</html>